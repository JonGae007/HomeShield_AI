<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/faces.css">
    <link rel="icon" type="image/x-icon" href="/static/icons/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesichterverwaltung</title>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="/static/icons/logo.png" alt="HomeShieldAI">
            <h2>HomeShieldAI</h2>
        </div>
        <ul class="menu">
            <li><a href="/dashboard"><img src="/static/icons/dashboard.png" alt="Dashboard Icon"> Dashboard</a></li>
            <li><a href="/recordings"><img src="/static/icons/play.png" alt="Recordings Icon"> Aufzeichnungen</a></li>
            <li><a href="/faces" class="active"><img src="/static/icons/face.png" alt="Faces Icon"> Gesichter</a></li>
            <li><a href="/settings"><img src="/static/icons/settings.png" alt="Settings Icon"> Einstellungen</a></li>
        </ul>
        <footer>
            <p>Created by Raik and Jonas</p>
        </footer>
    </div>
    <a href="/account" class="topbar">
        <img src="/static/icons/user.png" alt="User Icon">
        {{ username }}
    </a>
    <div class="content">
        <h1>Gesichterverwaltung</h1>
        
        <!-- Fehlermeldungen und Erfolgsmeldungen -->
        {% if error %}
        <div class="alert alert-error">
            <span class="alert-icon">‚ö†Ô∏è</span>
            {{ error }}
        </div>
        {% endif %}
        
        {% if success %}
        <div class="alert alert-success">
            <span class="alert-icon">‚úÖ</span>
            {{ success }}
        </div>
        {% endif %}
        
        <div class="faces-container">
            <!-- Neues Gesicht hinzuf√ºgen -->
            <div class="faces-card">
                <h2 class="section-title">
                    <img src="/static/icons/face.png" alt="Add Face Icon" class="section-icon">
                    Neues Gesicht hinzuf√ºgen
                </h2>
                
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-button active" onclick="switchTab('upload')">Bild hochladen</button>
                    <button class="tab-button" onclick="switchTab('camera')">Mit Kamera fotografieren</button>
                </div>
                
                <!-- Upload Tab -->
                <div id="uploadTab" class="tab-content active">
                    <form id="addFaceForm" class="face-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="faceName">Name</label>
                            <input type="text" id="faceName" name="name" placeholder="Name der Person eingeben" required>
                        </div>
                        <div class="form-group">
                            <label for="faceImage">Bild ausw√§hlen</label>
                            <input type="file" id="faceImage" name="image" accept="image/*" required>
                            <div class="file-info">Unterst√ºtzte Formate: JPG, PNG, GIF</div>
                        </div>
                        <button type="submit" class="btn-faces btn-primary">
                            <img src="/static/icons/face.png" alt="Add Icon">
                            Gesicht hinzuf√ºgen
                        </button>
                    </form>
                </div>
                
                <!-- Camera Tab -->
                <div id="cameraTab" class="tab-content">
                    <form id="cameraFaceForm" class="face-form">
                        <div class="form-group">
                            <label for="cameraFaceName">Name</label>
                            <input type="text" id="cameraFaceName" name="name" placeholder="Name der Person eingeben" required>
                        </div>
                        <div class="form-group">
                            <label for="cameraSelect">Kamera ausw√§hlen</label>
                            <select id="cameraSelect" name="camera_id" required>
                                <option value="">Kamera ausw√§hlen...</option>
                            </select>
                        </div>
                        <div class="camera-preview">
                            <img id="cameraPreview" src="" alt="Kamera-Vorschau" style="display: none;">
                            <div id="cameraPlaceholder" class="camera-placeholder">
                                <img src="/static/icons/camera.png" alt="Camera">
                                <p>W√§hlen Sie eine Kamera aus, um eine Vorschau zu sehen</p>
                            </div>
                        </div>
                        <div class="camera-controls">
                            <button type="button" id="refreshPreview" class="btn-faces btn-secondary" onclick="refreshCameraPreview()">
                                <img src="/static/icons/camera.png" alt="Refresh">
                                Vorschau aktualisieren
                            </button>
                            <button type="submit" class="btn-faces btn-primary">
                                <img src="/static/icons/camera.png" alt="Capture">
                                Foto aufnehmen & speichern
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bekannte Gesichter anzeigen -->
            <div class="faces-card">
                <h2 class="section-title">
                    <img src="/static/icons/user.png" alt="Known Faces Icon" class="section-icon">
                    Bekannte Gesichter ({{ known_faces|length }})
                </h2>
                <div class="faces-grid" id="facesGrid">
                    {% for face in known_faces %}
                    <div class="face-item" data-name="{{ face.Name }}">
                        <div class="face-image-container">
                            <img src="/static/faces/{{ face.Image }}" alt="{{ face.Name }}" class="face-image" onerror="this.src='/static/icons/user.png'">
                        </div>
                        <div class="face-info">
                            <h3 class="face-name">{{ face.Name }}</h3>
                            <button class="btn-faces btn-danger btn-small" onclick="deleteFace('{{ face.Name }}')">
                                <span class="delete-icon">üóëÔ∏è</span>
                                L√∂schen
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% if known_faces|length == 0 %}
                    <div class="no-faces">
                        <img src="/static/icons/face.png" alt="No Faces" class="no-faces-icon">
                        <h3>Keine Gesichter gespeichert</h3>
                        <p>F√ºgen Sie das erste Gesicht hinzu, um mit der Erkennung zu beginnen.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Gesichtserkennung testen -->
            <div class="faces-card">
                <h2 class="section-title">
                    <img src="/static/icons/camera.png" alt="Recognition Icon" class="section-icon">
                    Gesichtserkennung testen
                </h2>
                <div class="recognition-form">
                    <div class="form-group">
                        <label for="recognitionCamera">Kamera ausw√§hlen</label>
                        <select id="recognitionCamera" name="camera_id" required>
                            <option value="">Kamera ausw√§hlen...</option>
                        </select>
                    </div>
                    <div class="recognition-preview">
                        <img id="recognitionPreview" src="" alt="Erkennungs-Vorschau" style="display: none;">
                        <div id="recognitionPlaceholder" class="camera-placeholder">
                            <img src="/static/icons/camera.png" alt="Camera">
                            <p>W√§hlen Sie eine Kamera f√ºr die Gesichtserkennung</p>
                        </div>
                    </div>
                    <div class="recognition-controls">
                        <button type="button" class="btn-faces btn-secondary" onclick="refreshRecognitionPreview()">
                            <img src="/static/icons/camera.png" alt="Refresh">
                            Vorschau aktualisieren
                        </button>
                        <button type="button" class="btn-faces btn-primary" onclick="performFaceRecognition()">
                            <img src="/static/icons/face.png" alt="Recognize">
                            Gesicht erkennen
                        </button>
                    </div>
                    <div id="recognitionResult" class="recognition-result" style="display: none;">
                        <!-- Erkennungsergebnis wird hier angezeigt -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Face Modal -->
        <div id="deleteFaceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Gesicht l√∂schen</h3>
                    <span class="close" onclick="closeDeleteModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <p>‚ö†Ô∏è <strong>Warnung:</strong> Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!</p>
                    <p>M√∂chten Sie das Gesicht von <strong id="faceToDelete"></strong> wirklich l√∂schen?</p>
                    <div class="modal-buttons">
                        <button type="button" class="btn-faces btn-secondary" onclick="closeDeleteModal()">Abbrechen</button>
                        <button type="button" class="btn-faces btn-danger" onclick="confirmDeleteFace()">L√∂schen</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let currentFaceToDelete = null;
            let cameras = [];

            // Beim Laden der Seite Kameras laden
            document.addEventListener('DOMContentLoaded', function() {
                loadCameras();
            });

            // Kameras laden
            async function loadCameras() {
                try {
                    const response = await fetch('/api/cameras');
                    const result = await response.json();
                    
                    if (result.success) {
                        cameras = result.cameras;
                        updateCameraSelects();
                    }
                } catch (error) {
                    console.error('Fehler beim Laden der Kameras:', error);
                }
            }

            // Kamera-Dropdowns aktualisieren
            function updateCameraSelects() {
                const cameraSelect = document.getElementById('cameraSelect');
                const recognitionCamera = document.getElementById('recognitionCamera');
                
                [cameraSelect, recognitionCamera].forEach(select => {
                    select.innerHTML = '<option value="">Kamera ausw√§hlen...</option>';
                    cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.id;
                        option.textContent = `${camera.name} (${camera.ip_address})`;
                        select.appendChild(option);
                    });
                });
            }

            // Tab-Funktionalit√§t
            function switchTab(tabName) {
                // Tab-Buttons aktualisieren
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
                
                // Tab-Content aktualisieren
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName + 'Tab').classList.add('active');
            }

            // Kamera-Vorschau aktualisieren
            function refreshCameraPreview() {
                const cameraId = document.getElementById('cameraSelect').value;
                if (!cameraId) {
                    showAlert('Bitte w√§hlen Sie eine Kamera aus', 'error');
                    return;
                }
                
                const camera = cameras.find(c => c.id == cameraId);
                if (camera) {
                    const previewImg = document.getElementById('cameraPreview');
                    const placeholder = document.getElementById('cameraPlaceholder');
                    
                    previewImg.src = `http://${camera.ip_address}:8080/?action=snapshot&t=${Date.now()}`;
                    previewImg.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            }

            // Erkennungs-Vorschau aktualisieren
            function refreshRecognitionPreview() {
                const cameraId = document.getElementById('recognitionCamera').value;
                if (!cameraId) {
                    showAlert('Bitte w√§hlen Sie eine Kamera aus', 'error');
                    return;
                }
                
                const camera = cameras.find(c => c.id == cameraId);
                if (camera) {
                    const previewImg = document.getElementById('recognitionPreview');
                    const placeholder = document.getElementById('recognitionPlaceholder');
                    
                    previewImg.src = `http://${camera.ip_address}:8080/?action=snapshot&t=${Date.now()}`;
                    previewImg.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            }

            // Gesichtserkennung durchf√ºhren
            async function performFaceRecognition() {
                const cameraId = document.getElementById('recognitionCamera').value;
                if (!cameraId) {
                    showAlert('Bitte w√§hlen Sie eine Kamera aus', 'error');
                    return;
                }

                const button = document.querySelector('[onclick="performFaceRecognition()"]');
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = '<img src="/static/icons/face.png" alt="Loading"> Erkenne Gesicht...';

                try {
                    const response = await fetch(`/api/camera/${cameraId}/recognize_face`, {
                        method: 'POST'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        displayRecognitionResult(result);
                    } else {
                        showAlert(result.error, 'error');
                    }
                } catch (error) {
                    showAlert('Fehler bei der Gesichtserkennung', 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            }

            // Erkennungsergebnis anzeigen
            function displayRecognitionResult(result) {
                const resultDiv = document.getElementById('recognitionResult');
                
                if (result.recognized) {
                    resultDiv.innerHTML = `
                        <div class="recognition-success">
                            <h3>‚úÖ Gesicht erkannt!</h3>
                            <p><strong>Person:</strong> ${result.name}</p>
                            <p><strong>Vertrauen:</strong> ${(result.confidence * 100).toFixed(1)}%</p>
                            <p><strong>Kamera:</strong> ${result.camera}</p>
                        </div>
                    `;
                    resultDiv.className = 'recognition-result success';
                } else {
                    resultDiv.innerHTML = `
                        <div class="recognition-fail">
                            <h3>‚ùå Kein bekanntes Gesicht erkannt</h3>
                            <p>Die Person wurde nicht in der Datenbank gefunden.</p>
                        </div>
                    `;
                    resultDiv.className = 'recognition-result fail';
                }
                
                resultDiv.style.display = 'block';
            }

            // Formular f√ºr neues Gesicht (Upload)
            document.getElementById('addFaceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const submitButton = this.querySelector('button[type="submit"]');
                
                submitButton.disabled = true;
                submitButton.innerHTML = '<img src="/static/icons/face.png" alt="Loading"> Wird hinzugef√ºgt...';
                
                try {
                    const response = await fetch('/api/faces', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = '/faces?success=' + encodeURIComponent(result.message);
                    } else {
                        showAlert(result.error, 'error');
                    }
                } catch (error) {
                    showAlert('Fehler beim Hinzuf√ºgen des Gesichts', 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<img src="/static/icons/face.png" alt="Add Icon"> Gesicht hinzuf√ºgen';
                }
            });

            // Formular f√ºr Kamera-Foto
            document.getElementById('cameraFaceForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const cameraId = document.getElementById('cameraSelect').value;
                const name = document.getElementById('cameraFaceName').value.trim();
                
                if (!cameraId || !name) {
                    showAlert('Bitte w√§hlen Sie eine Kamera aus und geben Sie einen Namen ein', 'error');
                    return;
                }
                
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = '<img src="/static/icons/camera.png" alt="Loading"> Nehme Foto auf...';
                
                try {
                    const response = await fetch(`/api/camera/${cameraId}/capture_face`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: name })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = '/faces?success=' + encodeURIComponent(result.message);
                    } else {
                        showAlert(result.error, 'error');
                    }
                } catch (error) {
                    showAlert('Fehler beim Aufnehmen des Fotos', 'error');
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<img src="/static/icons/camera.png" alt="Capture"> Foto aufnehmen & speichern';
                }
            });

            // Gesicht l√∂schen
            function deleteFace(name) {
                currentFaceToDelete = name;
                document.getElementById('faceToDelete').textContent = name;
                document.getElementById('deleteFaceModal').style.display = 'block';
            }

            async function confirmDeleteFace() {
                if (!currentFaceToDelete) return;
                
                try {
                    const response = await fetch(`/api/faces/${encodeURIComponent(currentFaceToDelete)}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        window.location.href = '/faces?success=' + encodeURIComponent(result.message);
                    } else {
                        showAlert(result.error, 'error');
                        closeDeleteModal();
                    }
                } catch (error) {
                    showAlert('Fehler beim L√∂schen des Gesichts', 'error');
                    closeDeleteModal();
                }
            }

            function closeDeleteModal() {
                document.getElementById('deleteFaceModal').style.display = 'none';
                currentFaceToDelete = null;
            }

            // Alert anzeigen
            function showAlert(message, type) {
                const alertClass = type === 'error' ? 'alert-error' : 'alert-success';
                const icon = type === 'error' ? '‚ö†Ô∏è' : '‚úÖ';
                
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alertClass}`;
                alertDiv.innerHTML = `
                    <span class="alert-icon">${icon}</span>
                    ${message}
                `;
                
                const content = document.querySelector('.content');
                const existingAlert = content.querySelector('.alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                content.insertBefore(alertDiv, content.firstElementChild.nextElementSibling);
                
                // Alert nach 5 Sekunden ausblenden
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }

            // Modal schlie√üen bei Klick au√üerhalb
            window.onclick = function(event) {
                const modal = document.getElementById('deleteFaceModal');
                if (event.target == modal) {
                    closeDeleteModal();
                }
            }
        </script>
    </div>
</body>
</html>
