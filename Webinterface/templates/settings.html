<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/icons/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
</head>
<script>
  // --- Daten (Initialwerte); werden in LocalStorage gespeichert ---
  const STORAGE_KEY = 'hsai:cameras';
  const DEFAULT_CAMERAS = [
    { id: 1, name: 'Kamera 1', settings: { resolution: '1920x1080', label: 'Eingang',     ip: '192.168.186.10:80' } },
    { id: 2, name: 'Kamera 2', settings: { resolution: '1920x1080', label: 'Garage',     ip: '192.168.186.20:80' } },
    { id: 3, name: 'Kamera 3', settings: { resolution: '1920x1080', label: 'Wohnzimmer', ip: '192.168.186.30:80' } },
    { id: 4, name: 'Kamera 4', settings: { resolution: '1920x1080', label: 'Außenkamera', ip: '192.168.186.50:80' } },
  ];
  const RESOLUTIONS = ['3840x2160','2560x1440','1920x1080','1280x720','640x480'];

  const loadCams = () => {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || DEFAULT_CAMERAS; }
    catch { return DEFAULT_CAMERAS; }
  };
  const saveCams = (cams) => localStorage.setItem(STORAGE_KEY, JSON.stringify(cams));

  function createEl(tag, attrs={}, ...children){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==='class') n.className = v;
      else if(k==='html') n.innerHTML = v;
      else if(k.startsWith('on')) n.addEventListener(k.slice(2).toLowerCase(), v);
      else n.setAttribute(k,v);
    });
    children.flat().forEach(c=> n.append(c instanceof Node ? c : document.createTextNode(c)));
    return n;
  }

  function renderCameras(){
    const container = document.getElementById('cams');
    container.innerHTML = '';
    const cams = loadCams();

    cams.forEach((cam, index) => {
      const item = createEl('div', { class: 'acc-item', id: `cam-${cam.id}` });

      const header = createEl('div', { class: 'acc-header', role:'button', tabindex:0, 'aria-expanded':'false' },
        createEl('div', { class: 'acc-title' }, cam.name),
        createEl('div', { class: 'chev' }, '›')
      );
      header.addEventListener('click', () => toggleItem(item));
      header.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleItem(item); }});

      const body = createEl('div', { class: 'acc-body' });
      const form = createEl('form', { onsubmit: (e)=>{ e.preventDefault(); handleSave(cam.id, form); } });

      // Row 1: Auflösung + Name
      const row1 = createEl('div', { class: 'form-row' });
      const sel = createEl('select', { name: 'resolution' }, ...RESOLUTIONS.map(r=>{
        const opt = createEl('option', { value: r }, r.replace('x',' × ')); if(r===cam.settings.resolution) opt.selected = true; return opt;
      }));
      row1.append(
        createEl('div', { class: 'field' },
          createEl('label', {}, 'Auflösung'),
          sel
        ),
        createEl('div', { class: 'field' },
          createEl('label', {}, 'Name'),
          createEl('input', { type: 'text', name: 'label', value: cam.settings.label || '' })
        )
      );

      // Row 2: IP
      const row2 = createEl('div', { class: 'form-row' });
      row2.append(
        createEl('div', { class: 'field', style: 'grid-column:1 / -1' },
          createEl('label', {}, 'IP'),
          createEl('input', { type: 'text', name: 'ip', value: cam.settings.ip || '' })
        )
      );

      // Save
      const saveRow = createEl('div', { class: 'save-row' },
        createEl('button', { type: 'submit', class: 'btn btn-primary' }, 'Speichern')
      );

      form.append(row1, row2, saveRow);
      body.append(form);
      item.append(header, body);
      container.append(item);

      // Optional: per Default Kamera 4 offen, Rest zu — wie im Screenshot
      if(index === cams.length - 1) toggleItem(item, true);
    });
  }

  function toggleItem(item, forceOpen=false){
    const isOpen = item.classList.contains('open');
    document.querySelectorAll('.acc-item').forEach(i=>{
      i.classList.remove('open');
      const h = i.querySelector('.acc-header');
      if(h) h.setAttribute('aria-expanded','false');
    });
    if(!isOpen || forceOpen){
      item.classList.add('open');
      const h = item.querySelector('.acc-header');
      if(h) h.setAttribute('aria-expanded','true');
    }
  }

  function handleSave(id, form){
    const cams = loadCams();
    const idx = cams.findIndex(c => c.id === id);
    const fd = new FormData(form);
    cams[idx].settings = {
      resolution: fd.get('resolution'),
      label: (fd.get('label') || '').trim(),
      ip: (fd.get('ip') || '').trim(),
    };
    saveCams(cams);
    showToast('Gespeichert');
  }

  function showToast(text){
    const t = document.getElementById('toast');
    if(!t) return;
    t.textContent = text;
    t.classList.add('show');
    setTimeout(()=> t.classList.remove('show'), 1600);
  }

  document.addEventListener('DOMContentLoaded', renderCameras);
</script>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="/static/icons/logo.png" alt="HomeShieldAI">
            <h2>HomeShieldAI</h2>
        </div>
        <ul class="menu">
            <li><a href="/dashboard"><img src="/static/icons/dashboard.png" alt="Dashboard Icon"> Dashboard</a></li>
            <li><a href="/recordings"><img src="/static/icons/play.png" alt="Recordings Icon"> Aufzeichnungen</a></li>
            <li><a href="/settings"  class="active"><img src="/static/icons/settings.png" alt="Settings Icon"> Einstellungen</a></li>
        </ul>
        <footer>
            <p>Created by Raik and Jonas</p>
        </footer>
    </div>
    <div class="topbar" href="/account">
        <img src="/static/icons/user.png" alt="User Icon">
        {{ username }}
    </div>
    <main class="content">
  <h1>Einstellungen</h1>
<section class="settings-card" aria-label="Kameras">
  <h2 class="section-title">Kameras</h2>
  <div id="cams" class="accordion"></div>
</section>
</main>

</body>
</html>
