<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/x-icon" href="/static/icons/logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
</head>
<script>
  // --- Daten aus der Datenbank laden ---
  let cameras = {{ cameras|tojson }};

  function createEl(tag, attrs={}, ...children){
    const n = document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if(k==='class') n.className = v;
      else if(k==='html') n.innerHTML = v;
      else if(k.startsWith('on')) n.addEventListener(k.slice(2).toLowerCase(), v);
      else n.setAttribute(k,v);
    });
    children.flat().forEach(c=> n.append(c instanceof Node ? c : document.createTextNode(c)));
    return n;
  }

  async function loadCameras() {
    try {
      const response = await fetch('/api/cameras');
      cameras = await response.json();
      renderCameras();
    } catch (error) {
      console.error('Fehler beim Laden der Kameras:', error);
      showToast('Fehler beim Laden der Kameras', 'error');
    }
  }

  function renderCameras(){
    const container = document.getElementById('cams');
    container.innerHTML = '';

    cameras.forEach((cam, index) => {
      const item = createEl('div', { class: 'acc-item', id: `cam-${cam.id}` });

      const header = createEl('div', { class: 'acc-header', role:'button', tabindex:0, 'aria-expanded':'false' },
        createEl('div', { class: 'acc-title' }, cam.name),
        createEl('div', { class: 'chev' }, '›')
      );
      header.addEventListener('click', () => toggleItem(item));
      header.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleItem(item); }});

      const body = createEl('div', { class: 'acc-body' });
      const form = createEl('form', { onsubmit: (e)=>{ e.preventDefault(); handleSave(cam.id, form); } });

      // Row 1: Auflösung + Name + IP
      const row1 = createEl('div', { class: 'form-row-triple' });
      const resolutionInput = createEl('input', { 
        type: 'text', 
        name: 'resolution', 
        value: cam.resolution || '1920x1080',
        placeholder: '1920x1080'
      });
      row1.append(
        createEl('div', { class: 'field' },
          createEl('label', {}, 'Auflösung'),
          resolutionInput
        ),
        createEl('div', { class: 'field' },
          createEl('label', {}, 'Name'),
          createEl('input', { type: 'text', name: 'name', value: cam.name || '' })
        ),
        createEl('div', { class: 'field' },
          createEl('label', {}, 'IP-Adresse'),
          createEl('input', { type: 'text', name: 'ip_address', value: cam.ip_address || '', placeholder: '192.168.1.100' })
        )
      );

      // Save
      const saveRow = createEl('div', { class: 'save-row' },
        createEl('button', { type: 'button', class: 'btn btn-danger', onclick: ()=>handleDelete(cam.id) }, 'Löschen'),
        createEl('button', { type: 'submit', class: 'btn btn-primary' }, 'Speichern')
      );

      form.append(row1, saveRow);
      body.append(form);
      item.append(header, body);
      container.append(item);
    });
  }

  function toggleItem(item, forceOpen=false){
    const isOpen = item.classList.contains('open');
    document.querySelectorAll('.acc-item').forEach(i=>{
      i.classList.remove('open');
      const h = i.querySelector('.acc-header');
      if(h) h.setAttribute('aria-expanded','false');
    });
    if(!isOpen || forceOpen){
      item.classList.add('open');
      const h = item.querySelector('.acc-header');
      if(h) h.setAttribute('aria-expanded','true');
    }
  }

  async function handleSave(id, form){
    const fd = new FormData(form);
    const data = {
      name: fd.get('name').trim(),
      ip_address: fd.get('ip_address').trim(),
      resolution: fd.get('resolution')
    };

    try {
      const response = await fetch(`/api/cameras/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      if (result.success) {
        showToast('Gespeichert', 'success');
        await loadCameras(); // Neu laden
      } else {
        showToast('Fehler beim Speichern', 'error');
      }
    } catch (error) {
      console.error('Fehler beim Speichern:', error);
      showToast('Fehler beim Speichern', 'error');
    }
  }

  async function handleDelete(id){
    if(!confirm('Möchten Sie diese Kamera wirklich löschen?')) return;

    try {
      const response = await fetch(`/api/cameras/${id}`, {
        method: 'DELETE'
      });

      const result = await response.json();
      if (result.success) {
        showToast('Kamera gelöscht', 'success');
        await loadCameras(); // Neu laden
      } else {
        showToast('Fehler beim Löschen', 'error');
      }
    } catch (error) {
      console.error('Fehler beim Löschen:', error);
      showToast('Fehler beim Löschen', 'error');
    }
  }

  async function handleAddCamera() {
    const data = {
      name: 'Neue Kamera',
      ip_address: '',
      resolution: '1920x1080'
    };

    try {
      const response = await fetch('/api/cameras', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();
      if (result.success) {
        showToast('Kamera hinzugefügt', 'success');
        await loadCameras(); // Neu laden
      } else {
        showToast('Fehler beim Hinzufügen', 'error');
      }
    } catch (error) {
      console.error('Fehler beim Hinzufügen:', error);
      showToast('Fehler beim Hinzufügen', 'error');
    }
  }

  function showToast(text, type = 'success'){
    const t = document.getElementById('toast') || createToast();
    t.textContent = text;
    t.className = `toast show ${type}`;
    setTimeout(()=> t.classList.remove('show'), 2000);
  }

  function createToast() {
    const toast = createEl('div', { id: 'toast', class: 'toast' });
    document.body.appendChild(toast);
    return toast;
  }

  document.addEventListener('DOMContentLoaded', renderCameras);
</script>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="/static/icons/logo.png" alt="HomeShieldAI">
            <h2>HomeShieldAI</h2>
        </div>
        <ul class="menu">
            <li><a href="/dashboard"><img src="/static/icons/dashboard.png" alt="Dashboard Icon"> Dashboard</a></li>
            <li><a href="/recordings"><img src="/static/icons/play.png" alt="Recordings Icon"> Aufzeichnungen</a></li>
            <li><a href="/faces"><img src="/static/icons/face.png" alt="Faces Icon"> Gesichter</a></li>
            <li><a href="/settings"  class="active"><img src="/static/icons/settings.png" alt="Settings Icon"> Einstellungen</a></li>
        </ul>
        <footer>
            <p>Created by Raik and Jonas</p>
        </footer>
    </div>
    <a href="/account" class="topbar">
        <img src="/static/icons/user.png" alt="User Icon">
        {{ username }}
    </a>
    <main class="content">
  <h1>Einstellungen</h1>
<section class="settings-card" aria-label="Kameras">
  <div class="section-title-wrap">
    <h2 class="section-title">Kameras</h2>
    <button class="icon-btn" onclick="handleAddCamera()" title="Neue Kamera hinzufügen">+</button>
  </div>
  <div id="cams" class="accordion"></div>
</section>
</main>

</body>
</html>
